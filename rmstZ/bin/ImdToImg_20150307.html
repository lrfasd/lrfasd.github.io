<!DOCTYPE html><html><head><meta http-equiv="Content-Type"content="text/html;charset=utf-8"/><meta name="name"content=""><meta name="binary"content=""><meta name="mode"content=""><style type="text/css">div#divRoot{text-align:center;}
div#divTitle{clear:both;text-align:center;padding:3px;}
div#divOperate{text-align:center;}
div#divResult{margin:16px;}
div#divCopyright{clear:both;text-align:center;padding:3px;}</style></head><body><div id="divRoot"><div id="divTitle">ImdToImg</div><div id="divFileReader"><input type="file"id="inputFile"onchange="ReadFile(this.id)"/></div><div id="divOperate"><a id="aSave">保存</a><select id="selectMode"onchange="SelectChange()"><option value="txt">txt</option><option value="png"selected="selected">png</option><option value="html">html</option></select></div><div id="divResult"></div><div id="divCopyright">Copyright © 心のsky Group</div></div><script type="text/javascript">function GetMeta(n){var m=document.getElementsByTagName("meta");for(var i=0;i<m.length;i++){if(m[i].getAttribute("name")==n){return m[i].getAttribute("content");}}}
function SetMeta(n,c){var m=document.getElementsByTagName("meta");for(var i=0;i<m.length;i++){if(m[i].getAttribute("name")==n){m[i].setAttribute("content",c);return;}}}
function FillString(t,c,n,b){if((t=="")||(c.length!=1)||(n<=t.length)){return t;}
var r=new Array();r.push(t);for(var i=0;i<n-t.length;i++){if(b==true){r.unshift(c);}
else{r.push(c);}}
return r.join("");}
function BytesToHex(t){var r=new Array();for(var i=0;i<t.length;i++){r.push(FillString(t[i].toString(16).toUpperCase(),"0",2,true))}
return r.join(" ");}
function BytesToInt32(t){var r=0;var l=t.length;if(l>4){l=4;}
for(var i=0;i<l;i++){r+=t[i]*Math.pow(256,i);}
if(r>2147483647){r-=4294967296;}
return r;}
function MillisecondToTime(t){var m,s,ms;ms=t;m=Math.floor(ms/60000);ms-=m*60000;s=Math.floor(ms/1000);ms-=s*1000;return m.toString()+":"+s.toString()+"."+ms.toString();}
function TextToBase64(t){var r="";var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var c1,c2,c3;var i=0;while(i<t.length){c1=t.charCodeAt(i++)&0xFF;if(i==t.length){r+=c.charAt(c1>>2);r+=c.charAt((c1&0x3)<<4);r+="==";break;}
c2=t.charCodeAt(i++);if(i==t.length){r+=c.charAt(c1>>2);r+=c.charAt(((c1&0x3)<<4)|((c2&0xF0)>>4));r+=c.charAt((c2&0xF)<<2);r+="=";break;}
c3=t.charCodeAt(i++);r+=c.charAt(c1>>2);r+=c.charAt(((c1&0x3)<<4)|((c2&0xF0)>>4));r+=c.charAt(((c2&0xF)<<2)|((c3&0xC0)>>6));r+=c.charAt(c3&0x3F);}
return r;}
function ReadFile(fileId){if(typeof FileReader==='undefined'){document.write("No supported brower.");return;}
var r=new FileReader();r.onload=function(){SetMeta("binary",this.result);SelectChange();}
SetMeta("name",document.getElementById(fileId).files[0].name.replace(".imd",""));r.readAsBinaryString(document.getElementById(fileId).files[0]);}
function SelectChange(){var s=document.getElementById("selectMode");var m=s.options[s.selectedIndex].value;if(m!=GetMeta("mode")){SetMeta("mode",m);}
ReadImd();}
function ReadImd(){var b=GetMeta("binary");if(b==""){return;}
var imd=new Array();for(var i=0;i<b.length;i++){imd.push(b.charCodeAt(i));}
var p=0,t=0,a=0;var m=GetMeta("mode");switch(m){case"txt":var txt=new Array();txt.push(BytesToHex(imd.slice(p,p+4)));p+=4;t=BytesToInt32(imd.slice(p,p+4));txt.push(BytesToHex(imd.slice(p,p+4)));p+=4;for(var i=0;i<t;i++){txt.push(BytesToHex(imd.slice(p,p+12)));p+=12;}
txt.push(BytesToHex(imd.slice(p,p+2)));p+=2;a=BytesToInt32(imd.slice(p,p+4));txt.push(BytesToHex(imd.slice(p,p+4)));p+=4;for(var i=0;i<a;i++){txt.push(BytesToHex(imd.slice(p,p+11)));p+=11;}
var p=document.createElement("p");p.style.textAlign="left";p.innerHTML=txt.join("<br/>");var div=document.getElementById("divResult");div.innerHTML="";div.appendChild(p);var a=document.getElementById("aSave");a.href="data:text/plain;base64,"+TextToBase64(txt.join("\r\n"));a.download=GetMeta("name")+"."+m;break;case"png":var Time=0,Key=4;var Times=new Array(),Actions=new Array(),Timestamps=new Array(),Tracks=new Array(),Timespans=new Array();Time=BytesToInt32(imd.slice(p,p+4));p+=4;t=BytesToInt32(imd.slice(p,p+4));p+=4;for(var i=0;i<t;i++){Times.push(BytesToInt32(imd.slice(p,p+4)));p+=12;}
p+=2;a=BytesToInt32(imd.slice(p,p+4));p+=4;for(var i=0;i<a;i++){Actions.push(BytesToInt32(imd.slice(p,p+2)));Timestamps.push(BytesToInt32(imd.slice(p+2,p+6)));Tracks.push(BytesToInt32(imd.slice(p+6,p+7)));Timespans.push(BytesToInt32(imd.slice(p+7,p+11)));p+=11;}
for(var i=0;i<a;i++){if(Key!=5){if((Actions[i]!=0)&&((Tracks[i]==4)||(Tracks[i]+Timespans[i]==4))){Key=5;}}
if((Tracks[i]==5)||(Tracks[i]+Timespans[i]==5)){Key=6;break;}}
var PaddingTop=0,PaddingBottom=0,PaddingLeft=32,PaddingRight=32;var SpeedRate=Math.ceil(Time/(32767-PaddingTop-PaddingBottom));var CoreWidth=128,CoreHeight=Time/SpeedRate;var WholeWidth=PaddingLeft+CoreWidth+PaddingRight,WholeHeight=PaddingTop+CoreHeight+PaddingBottom;var NoteWidth=Math.round(CoreWidth/Key*(105-5*Key)/100),NoteHeight=CoreWidth/16;TouchNoteStyle="#0000FF";HoldNoteStyle="#00FF00";var StrokeWidth=CoreWidth/32,StrokeStyle="#00FF00",ArrowStyle="#00FF00";;var cvs=document.createElement("canvas");cvs.style.display="none";cvs.width=WholeWidth;cvs.height=WholeHeight;var ctx=cvs.getContext("2d");ctx.fillStyle="#FFFFFF";ctx.fillRect(0,0,cvs.width,cvs.height);ctx.globalAlpha=0.618;var DrawNote=function(a,x,y){switch(a){case 0:ctx.fillStyle=TouchNoteStyle;break;default:ctx.fillStyle=HoldNoteStyle;break;}
ctx.fillRect(Math.round(x-NoteWidth/2),Math.round(y-NoteHeight/2),NoteWidth,NoteHeight);}
var DrawStroke=function(x1,y1,x2,y2){ctx.lineWidth=StrokeWidth;ctx.strokeStyle=StrokeStyle;ctx.beginPath();ctx.moveTo(Math.round(x1),Math.round(y1));ctx.lineTo(Math.round(x2),Math.round(y2));ctx.stroke();}
var DrawArrow=function(t,x,y){ctx.lineWidth=1;ctx.fillStyle=ArrowStyle;ctx.beginPath();if(t<0){ctx.moveTo(Math.round(x+StrokeWidth/2),Math.round(y+StrokeWidth));ctx.lineTo(Math.round(x+StrokeWidth/2),Math.round(y-StrokeWidth));ctx.lineTo(Math.round(x+StrokeWidth/2-StrokeWidth*2),Math.round(y));}
else if(t>0){ctx.moveTo(Math.round(x-StrokeWidth/2),Math.round(y+StrokeWidth));ctx.lineTo(Math.round(x-StrokeWidth/2),Math.round(y-StrokeWidth));ctx.lineTo(Math.round(x-StrokeWidth/2+StrokeWidth*2),Math.round(y));}
ctx.closePath();ctx.fill();}
var DrawKey=function(Action,Timestamp,Track,Timespan){switch(Action){case 0:DrawNote(Action,CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);break;case 1:DrawNote(Action,CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);if(Timespan<0){DrawStroke(CoreWidth/Key*(Track+0.5+Timespan)+StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)-NoteWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);DrawArrow(Timespan,CoreWidth/Key*(Track+0.5+Timespan)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);}
else if(Timespan>0){DrawStroke(CoreWidth/Key*(Track+0.5)+NoteWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5+Timespan)-StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);DrawArrow(Timespan,CoreWidth/Key*(Track+0.5+Timespan)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);}
break;case 2:DrawNote(Action,CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);DrawStroke(CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-NoteHeight/2-PaddingBottom,CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-Timespan/SpeedRate+StrokeWidth/2-PaddingBottom);DrawStroke(CoreWidth/Key*(Track+0.5)-StrokeWidth+PaddingLeft,CoreHeight-Timestamp/SpeedRate-Timespan/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)+StrokeWidth+PaddingLeft,CoreHeight-Timestamp/SpeedRate-Timespan/SpeedRate-PaddingBottom);break;case 97:DrawNote(Action,CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);if(Timespan<0){DrawStroke(CoreWidth/Key*(Track+0.5+Timespan)-StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)-NoteWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);}
else if(Timespan>0){DrawStroke(CoreWidth/Key*(Track+0.5)+NoteWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5+Timespan)+StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);}
break;case 98:DrawNote(Action,CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);DrawStroke(CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-NoteHeight/2-PaddingBottom,CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-Timespan/SpeedRate+StrokeWidth/2-PaddingBottom);break;case 33:if(Timespan<0){DrawStroke(CoreWidth/Key*(Track+0.5+Timespan)-StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)+StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);}
else if(Timespan>0){DrawStroke(CoreWidth/Key*(Track+0.5)-StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5+Timespan)+StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);}
break;case 34:DrawStroke(CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-StrokeWidth/2-PaddingBottom,CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-Timespan/SpeedRate+StrokeWidth/2-PaddingBottom);break;case 161:if(Timespan<0){DrawStroke(CoreWidth/Key*(Track+0.5+Timespan)+StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)+StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);DrawArrow(Timespan,CoreWidth/Key*(Track+0.5+Timespan)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);}
else if(Timespan>0){DrawStroke(CoreWidth/Key*(Track+0.5)-StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5+Timespan)-StrokeWidth/2+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);DrawArrow(Timespan,CoreWidth/Key*(Track+0.5+Timespan)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-PaddingBottom);}
break;case 162:DrawStroke(CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-StrokeWidth/2-PaddingBottom,CoreWidth/Key*(Track+0.5)+PaddingLeft,CoreHeight-Timestamp/SpeedRate-Timespan/SpeedRate+StrokeWidth/2-PaddingBottom);DrawStroke(CoreWidth/Key*(Track+0.5)-StrokeWidth+PaddingLeft,CoreHeight-Timestamp/SpeedRate-Timespan/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)+StrokeWidth+PaddingLeft,CoreHeight-Timestamp/SpeedRate-Timespan/SpeedRate-PaddingBottom);break;}}
for(var i=0;i<a;i++){DrawKey(Actions[i],Timestamps[i],Tracks[i],Timespans[i])}
var img=document.createElement("img");img.width=cvs.width;img.height=cvs.height;img.src=cvs.toDataURL("image/png");var div=document.getElementById("divResult");div.innerHTML="";div.appendChild(img);var a=document.getElementById("aSave");a.href=img.src;a.download=GetMeta("name")+"."+m;break;case"html":break;}}</script></body></html>
